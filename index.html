<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Jogadores</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #tema_preto {
            background-color: #121212;
            color: #f5f5f5;
        }
        .card {
            background-color: #1e1e1e;
            color: #f5f5f5;
            margin-bottom: 20px;
        }
        .form-control, .form-select {
            background-color: #2d2d2d;
            color: #f5f5f5;
            border-color: #444;
        }
        .form-control:focus, .form-select:focus {
            background-color: #2d2d2d;
            color: #f5f5f5;
        }
        .form-label {
            color: #f5f5f5;
        }
        .property-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .property-item label {
            margin-right: 10px;
            margin-bottom: 0;
        }
        .player-notes {
            width: 100%;
            min-height: 100px;
            margin-top: 10px;
        }
        .property-selection {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 5px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body class="container py-4" id="tema_preto">
    <h1 class="text-center mb-4">Gerenciador de Jogadores</h1>
    
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="mb-3">
                <label for="playerName" class="form-label">Nome do Jogador</label>
                <input type="text" id="playerName" class="form-control" placeholder="Digite o nome">
            </div>
        </div>
        <div class="col-md-4">
            <div class="mb-3">
                <label for="playerMoney" class="form-label">Dinheiro Inicial</label>
                <input type="number" id="playerMoney" class="form-control" placeholder="Digite o valor inicial">
            </div>
        </div>
        <div class="col-md-4 d-flex align-items-end">
            <button class="btn btn-primary mb-3 w-100" onclick="addPlayer()">Adicionar Jogador</button>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-4">
            <button class="btn btn-success w-100" onclick="exportData('json')">Exportar JSON</button>
        </div>
        <div class="col-md-4">
            <button class="btn btn-success w-100" onclick="exportData('markdown')">Exportar Markdown</button>
        </div>
        <div class="col-md-4">
            <button class="btn btn-success w-100" onclick="exportData('pdf')">Exportar PDF</button>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-6">
            <button class="btn btn-warning w-100" onclick="newSave()">Novo Save</button>
        </div>
        <div class="col-md-6">
            <button class="btn btn-info w-100" onclick="loadSaveFromFile()">Carregar Save</button>
            <input type="file" id="loadSaveInput" style="display: none;" accept=".json" onchange="handleFileSelect(event)">
        </div>
    </div>

    <h2 class="mt-4 mb-3">Jogadores</h2>
    <div id="playersList"></div>
    
    <!-- Modal para seleção múltipla de propriedades -->
    <div class="modal fade" id="propertyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header">
                    <h5 class="modal-title">Selecionar Propriedades</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="property-selection">
                        <div id="propertyCheckboxes"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="confirmProperties()">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/js
.umd.min.js"></script>
    
    <script>
        let players = [];
        let currentPlayerForProperties = -1;
        
        const availableProperties = [
            "Av. 9 de julho", "Av. Brasil", "Av. Beira Mar", "Av. Rio Branco", "Av. do Estado", "Av. do Contorno",
            "Av. Rebouças", "Av. Santo Amaro", "Rua da Consolação", "Av. Morumbi", "Av. Higienópolis",
            "Av. São João", "Av. Ipiranga", "Rua Brigadeiro Faria Lima", "Av. Paulista", "Av. Recife",
            "Juscelino Kubitschek", "Rua Oscar Freire", "Av. Ibirapuera", "Av. Vieira Souto", "Av. Presidente Vargas",
            "Av. Niemeyer", "Ações do Banco Itaú", "Ações da TAM viagens", "Ações dos Postos Ipiranga",
            "Ações da Nivea", "Ações da Vivo", "Ações da Fiat"
        ];
        
        // Inicializar o Modal de Bootstrap
        let propertyModal;
        document.addEventListener('DOMContentLoaded', function() {
            propertyModal = new bootstrap.Modal(document.getElementById('propertyModal'));
            
            // Tentar carregar dados salvos localmente
            const savedData = localStorage.getItem('playersData');
            if (savedData) {
                try {
                    players = JSON.parse(savedData);
                    updatePlayerList();
                } catch (e) {
                    console.error("Erro ao carregar dados salvos:", e);
                }
            }
        });
        
        function addPlayer() {
            const name = document.getElementById('playerName').value.trim();
            const money = parseFloat(document.getElementById('playerMoney').value);
            
            if (!name || isNaN(money)) {
                alert("Por favor, preencha o nome e o dinheiro inicial do jogador.");
                return;
            }
            
            // Adiciona o novo jogador no início da lista
            players.unshift({ 
                name, 
                money, 
                properties: [],
                notes: ""
            });
            
            // Limpa os campos do formulário
            document.getElementById('playerName').value = '';
            document.getElementById('playerMoney').value = '';
            
            updatePlayerList();
            saveToLocalStorage();
        }
        
        function removePlayer(index) {
            if (confirm(`Tem certeza que deseja remover ${players[index].name}?`)) {
                players.splice(index, 1);
                updatePlayerList();
                saveToLocalStorage();
            }
        }
        
        function updateMoney(index) {
            const amount = parseFloat(document.getElementById(`moneyInput-${index}`).value);
            if (!isNaN(amount)) {
                players[index].money += amount;
                document.getElementById(`moneyInput-${index}`).value = '';
                updatePlayerList();
                saveToLocalStorage();
            } else {
                alert("Por favor, insira um valor válido.");
            }
        }
        
        function setMoney(index) {
            const amount = parseFloat(document.getElementById(`moneyInput-${index}`).value);
            if (!isNaN(amount)) {
                players[index].money = amount;
                document.getElementById(`moneyInput-${index}`).value = '';
                updatePlayerList();
                saveToLocalStorage();
            } else {
                alert("Por favor, insira um valor válido.");
            }
        }
        
        function openPropertySelection(index) {
            currentPlayerForProperties = index;
            
            // Preparar o conteúdo do modal
            const checkboxesContainer = document.getElementById('propertyCheckboxes');
            checkboxesContainer.innerHTML = '';
            
            let currentPlayerProps = players[index].properties.map(p => p.name);
            
            // Criar lista de todas as propriedades
            availableProperties.forEach((prop, propIndex) => {
                // Verificar se a propriedade já está com outro jogador
                let isOwnedByOther = false;
                let ownerName = "";
                
                players.forEach((player, playerIndex) => {
                    if (playerIndex !== index && player.properties.some(p => p.name === prop)) {
                        isOwnedByOther = true;
                        ownerName = player.name;
                    }
                });
                
                const isOwned = currentPlayerProps.includes(prop);
                
                const div = document.createElement('div');
                div.className = 'property-item mb-3';
                
                // Se já pertence a outro jogador, mostrar desabilitado com informação
                if (isOwnedByOther) {
                    div.innerHTML = `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="prop-${propIndex}" 
                                   value="${prop}" disabled>
                            <label class="form-check-label" for="prop-${propIndex}">
                                ${prop} <span class="text-warning">(Pertence a ${ownerName})</span>
                            </label>
                        </div>
                    `;
                    checkboxesContainer.appendChild(div);
                    return;
                }
                
                // Propriedade disponível ou já do jogador atual
                div.innerHTML = `
                    <div class="d-flex flex-column w-100">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="prop-${propIndex}" 
                                   value="${prop}" ${isOwned ? 'checked' : ''}>
                            <label class="form-check-label" for="prop-${propIndex}">${prop}</label>
                        </div>
                        <div class="d-flex align-items-center mt-2 ms-4 ${isOwned ? '' : 'd-none'}" id="house-controls-${propIndex}">
                            <label class="me-2">Construções:</label>
                            <select class="form-select form-select-sm" style="width: auto;" id="house-select-${propIndex}">
                                <option value="0">0 casas</option>
                                <option value="1">1 casa</option>
                                <option value="2">2 casas</option>
                                <option value="3">3 casas</option>
                                <option value="Hotel">Hotel</option>
                            </select>
                        </div>
                    </div>
                `;
                
                checkboxesContainer.appendChild(div);
                
                // Se já possui, selecionar o número correto de casas
                if (isOwned) {
                    const propObj = players[index].properties.find(p => p.name === prop);
                    const select = document.getElementById(`house-select-${propIndex}`);
                    select.value = propObj.houses;
                }
                
                // Adicionar evento para mostrar/esconder controle de casas
                const checkbox = document.getElementById(`prop-${propIndex}`);
                checkbox.addEventListener('change', function() {
                    const houseControls = document.getElementById(`house-controls-${propIndex}`);
                    houseControls.classList.toggle('d-none', !this.checked);
                });
            });
            
            propertyModal.show();
        }
        
        function confirmProperties() {
            const checkboxes = document.querySelectorAll('#propertyCheckboxes input[type="checkbox"]');
            const newProperties = [];
            
            checkboxes.forEach((checkbox, idx) => {
                if (checkbox.checked) {
                    const propName = checkbox.value;
                    const houseSelect = document.getElementById(`house-select-${idx}`);
                    const houses = houseSelect ? houseSelect.value : 0;
                    
                    newProperties.push({
                        name: propName,
                        houses: houses
                    });
                }
            });
            
            // Atualizar as propriedades do jogador
            players[currentPlayerForProperties].properties = newProperties;
            
            propertyModal.hide();
            updatePlayerList();
            saveToLocalStorage();
        }
        
        function addHouse(index, propIndex) {
            let property = players[index].properties[propIndex];
            if (property.houses === 0 || property.houses === '0') {
                property.houses = 1;
            } else if (property.houses === 1 || property.houses === '1') {
                property.houses = 2;
            } else if (property.houses === 2 || property.houses === '2') {
                property.houses = 3;
            } else if (property.houses === 3 || property.houses === '3') {
                property.houses = 'Hotel';
            }
            updatePlayerList();
            saveToLocalStorage();
        }
        
        function removeHouse(index, propIndex) {
            let property = players[index].properties[propIndex];
            if (property.houses === 'Hotel') {
                property.houses = 3;
            } else if (property.houses === 3 || property.houses === '3') {
                property.houses = 2;
            } else if (property.houses === 2 || property.houses === '2') {
                property.houses = 1;
            } else if (property.houses === 1 || property.houses === '1') {
                property.houses = 0;
            }
            updatePlayerList();
            saveToLocalStorage();
        }
        
        function removeProperty(index, propIndex) {
            if (confirm("Tem certeza que deseja remover esta propriedade?")) {
                players[index].properties.splice(propIndex, 1);
                updatePlayerList();
                saveToLocalStorage();
            }
        }
        
        function updateNotes(index) {
            const notes = document.getElementById(`notes-${index}`).value;
            players[index].notes = notes;
            saveToLocalStorage();
        }
        
        function updatePlayerList() {
            const list = document.getElementById('playersList');
            list.innerHTML = '';
            
            players.forEach((player, index) => {
                let propertiesHTML = '';
                
                if (player.properties.length > 0) {
                    propertiesHTML = '<ul class="list-group mt-3">';
                    player.properties.forEach((prop, propIndex) => {
                        propertiesHTML += `
                            <li class="list-group-item bg-dark text-light d-flex justify-content-between align-items-center">
                                <div>
                                    ${prop.name} 
                                    <span class="badge bg-secondary ms-2">
                                        ${prop.houses === 'Hotel' ? 'Hotel' : prop.houses + ' casas'}
                                    </span>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-success" onclick="addHouse(${index}, ${propIndex})">+ Casa</button>
                                    <button class="btn btn-sm btn-warning" onclick="removeHouse(${index}, ${propIndex})">- Casa</button>
                                    <button class="btn btn-sm btn-danger" onclick="removeProperty(${index}, ${propIndex})">Remover</button>
                                </div>
                            </li>
                        `;
                    });
                    propertiesHTML += '</ul>';
                } else {
                    propertiesHTML = '<p class="mt-3">Nenhuma propriedade</p>';
                }
                
                let playerCard = document.createElement("div");
                playerCard.id = `player-${index}`;
                playerCard.className = "card p-4 mb-4";
                
                playerCard.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h3>${player.name}</h3>
                        <button class="btn btn-danger" onclick="removePlayer(${index})">Remover Jogador</button>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p class="fs-5">Dinheiro: R$ ${player.money.toLocaleString('pt-BR')}</p>
                            <div class="input-group mb-3">
                                <input type="number" class="form-control" id="moneyInput-${index}" placeholder="Digite o valor">
                                <button class="btn btn-success" onclick="updateMoney(${index})">Atualizar</button>
                                <button class="btn btn-primary" onclick="setMoney(${index})">Definir</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-info w-100 mb-2" onclick="openPropertySelection(${index})">Gerenciar Propriedades</button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h5>Propriedades</h5>
                        ${propertiesHTML}
                    </div>
                    
                    <div>
                        <h5>Anotações</h5>
                        <textarea id="notes-${index}" class="form-control player-notes" oninput="updateNotes(${index})">${player.notes || ''}</textarea>
                    </div>
                `;
                
                list.appendChild(playerCard);
            });
        }
        
        function saveToLocalStorage() {
            try {
                localStorage.setItem('playersData', JSON.stringify(players));
            } catch (e) {
                console.error("Erro ao salvar dados:", e);
            }
        }
        
        function newSave() {
            if (confirm("Tem certeza que deseja criar um novo save? Todos os dados atuais serão perdidos.")) {
                players = [];
                updatePlayerList();
                saveToLocalStorage();
            }
        }
        
        function loadSaveFromFile() {
            document.getElementById('loadSaveInput').click();
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    if (Array.isArray(loadedData)) {
                        players = loadedData;
                        updatePlayerList();
                        saveToLocalStorage();
                        alert("Save carregado com sucesso!");
                    } else {
                        alert("Formato de arquivo inválido.");
                    }
                } catch (error) {
                    alert("Erro ao ler o arquivo: " + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        function exportData(format) {
            if (players.length === 0) {
                alert("Não há dados para exportar!");
                return;
            }
            
            switch (format) {
                case 'json':
                    exportJSON();
                    break;
                case 'markdown':
                    exportMarkdown();
                    break;
                case 'pdf':
                    exportPDF();
                    break;
            }
        }
        
        function exportJSON() {
            const dataStr = JSON.stringify(players, null, 2);
            const dataUri = "data:application/json;charset=utf-8," + encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'gerenciador-jogadores.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        function exportMarkdown() {
            let markdown = "# Gerenciador de Jogadores\n\n";
            
            players.forEach((player, index) => {
                markdown += `## ${player.name}\n\n`;
                markdown += `- Dinheiro: R$ ${player.money.toLocaleString('pt-BR')}\n\n`;
                
                if (player.properties.length > 0) {
                    markdown += "### Propriedades\n\n";
                    player.properties.forEach(prop => {
                        markdown += `- ${prop.name}: ${prop.houses === 'Hotel' ? 'Hotel' : prop.houses + ' casas'}\n`;
                    });
                    markdown += "\n";
                } else {
                    markdown += "### Propriedades\nNenhuma propriedade\n\n";
                }
                
                if (player.notes && player.notes.trim() !== '') {
                    markdown += "### Anotações\n\n";
                    markdown += `${player.notes}\n\n`;
                } else {
                    markdown += "### Anotações\nNenhuma anotação\n\n";
                }
                
                markdown += "---\n\n";
            });
            
            const dataUri = "data:text/markdown;charset=utf-8," + encodeURIComponent(markdown);
            const exportFileDefaultName = 'gerenciador-jogadores.md';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        function exportPDF() {
            // Inicializar jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPos = 20;
            const pageHeight = doc.internal.pageSize.height;
            
            // Título
            doc.setFontSize(20);
            doc.text("Gerenciador de Jogadores", 105, yPos, { align: 'center' });
            yPos += 15;
            
            doc.setFontSize(12);
            
            players.forEach((player, index) => {
                // Verificar se é necessário uma nova página
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 20;
                }
                
                // Nome do jogador
                doc.setFontSize(16);
                doc.text(`${player.name}`, 10, yPos);
                yPos += 10;
                
                // Dinheiro
                doc.setFontSize(12);
                doc.text(`Dinheiro: R$ ${player.money.toLocaleString('pt-BR')}`, 10, yPos);
                yPos += 10;
                
                // Propriedades
                doc.text("Propriedades:", 10, yPos);
                yPos += 8;
                
                if (player.properties.length > 0) {
                    player.properties.forEach(prop => {
                        // Verificar se é necessário uma nova página
                        if (yPos > pageHeight - 20) {
                            doc.addPage();
                            yPos = 20;
                        }
                        
                        doc.text(`- ${prop.name}: ${prop.houses === 'Hotel' ? 'Hotel' : prop.houses + ' casas'}`, 15, yPos);
                        yPos += 6;
                    });
                } else {
                    doc.text("- Nenhuma propriedade", 15, yPos);
                    yPos += 6;
                }
                
                yPos += 5;
                
                // Anotações
                doc.text("Anotações:", 10, yPos);
                yPos += 8;
                
                if (player.notes && player.notes.trim() !== '') {
                    // Quebrar o texto em linhas para que caiba na página
                    const splitText = doc.splitTextToSize(player.notes, 180);
                    
                    // Verificar se as anotações vão caber na página atual
                    if (yPos + (splitText.length * 6) > pageHeight - 20) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.text(splitText, 15, yPos);
                    yPos += (splitText.length * 6) + 5;
                } else {
                    doc.text("- Nenhuma anotação", 15, yPos);
                    yPos += 6;
                }
                
                // Separador entre jogadores
                yPos += 10;
                doc.setDrawColor(200);
                doc.line(10, yPos - 5, 200, yPos - 5);
                yPos += 10;
            });
            
            doc.save('gerenciador-jogadores.pdf');
        }
    </script>
</body>
</html>